name: Auto Assign Sidebar Position

on:
  pull_request:
    branches: [stg]
    types: [closed]

jobs:
  assign:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout stg branch (after merge)
        if: ${{ github.event.action == 'closed' && github.event.pull_request.merged == true }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine added markdown files (merged)
        if: ${{ github.event.action == 'closed' && github.event.pull_request.merged == true }}
        id: added_closed
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              per_page: 100,
            });
            const added = files.filter(f => f.status === 'added' && f.filename.endsWith('.md')).map(f => f.filename).join('\n');
            core.setOutput('added_files', added);

      - name: Create added file list variable
        id: collect
        run: |
          FILES="${{ steps.added_open.outputs.added_files }}${{ steps.added_closed.outputs.added_files }}"
          echo "FILES=$FILES" >> $GITHUB_ENV
          echo "Collected added files:"; echo "$FILES"

      - name: Run sidebar position assignment
        if: ${{ env.FILES != '' && github.event.action == 'closed' && github.event.pull_request.merged == true }}
        run: |
          node scripts/assign-sidebar-position.js "$FILES"

      - name: Commit changes
        if: ${{ env.FILES != '' }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add $FILES
          git commit -m "Assign sidebar_position to new docs" || echo "No changes"
          git push
